/**
 * Update database references (foods.imageUrl, users.avatarUrl) to Cloudinary URLs
 * using the mapping generated by cloudinary-upload-report.json.
 *
 * Run from backend folder:
 *   CLOUDINARY_URL=cloudinary://... MONGO_URL=... node scripts/migrate-images-to-cloudinary.js
 */
import fs from "fs/promises";
import path from "path";
import { fileURLToPath } from "url";
import { connectDB } from "../config/db.js";
import FoodModel from "../models/v2/foodModel.js";
import UserModel from "../models/userModel.js";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const REPORT_PATH = path.resolve(__dirname, "..", "cloudinary-upload-report.json");

const loadReport = async () => {
  const raw = await fs.readFile(REPORT_PATH, "utf-8");
  const data = JSON.parse(raw);
  const lookup = new Map();

  data.forEach((entry) => {
    const source = entry.source || "";
    const secureUrl = entry.secure_url || entry.url || "";
    if (!source || !secureUrl) return;
    const base = path.basename(source).toLowerCase();
    lookup.set(base, secureUrl);
  });

  return lookup;
};

const normaliseKey = (value = "") => {
  const cleaned = String(value)
    .replace(/^https?:\/\//i, "")
    .replace(/^images[\\/]/i, "")
    .replace(/^uploads[\\/]/i, "");
  return path.basename(cleaned).toLowerCase();
};

const resolveUrl = (lookup, current) => {
  if (!current) return null;
  if (/^https?:\/\//i.test(current)) return null; // already remote
  const key = normaliseKey(current);
  return lookup.get(key) || null;
};

const updateFoods = async (lookup) => {
  const foods = await FoodModel.find({
    imageUrl: { $exists: true, $ne: "" },
  });
  let updated = 0;
  for (const food of foods) {
    const nextUrl = resolveUrl(lookup, food.imageUrl);
    if (nextUrl && nextUrl !== food.imageUrl) {
      food.imageUrl = nextUrl;
      await food.save();
      updated += 1;
      console.log(`Updated food ${food._id} -> ${nextUrl}`);
    }
  }
  return updated;
};

const updateUsers = async (lookup) => {
  const users = await UserModel.find({
    avatarUrl: { $exists: true, $ne: "" },
  });
  let updated = 0;
  for (const user of users) {
    const nextUrl = resolveUrl(lookup, user.avatarUrl);
    if (nextUrl && nextUrl !== user.avatarUrl) {
      user.avatarUrl = nextUrl;
      await user.save();
      updated += 1;
      console.log(`Updated user ${user._id} avatar -> ${nextUrl}`);
    }
  }
  return updated;
};

const run = async () => {
  const lookup = await loadReport();
  console.log(`Loaded ${lookup.size} entries from cloudinary-upload-report.json`);
  await connectDB();
  const foodCount = await updateFoods(lookup);
  const userCount = await updateUsers(lookup);
  console.log(`Done. Foods updated: ${foodCount}, Users updated: ${userCount}`);
  process.exit(0);
};

run().catch((err) => {
  console.error("Migration failed:", err);
  process.exit(1);
});
